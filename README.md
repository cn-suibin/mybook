# mybook by suibin
#服务器架构相关
Apache BookKeeper
http://blog.csdn.net/plunger2011/article/details/37812843


1、用好thinkphp框架自带的。

	1.1用好-动态缓存（第一次查询缓存，有则从缓存取，一般用于一个事务中非实时性数据，设计依赖一个事务的生命周期。（比如排行榜，几小时更新一次，可以缓存，设置队列来控制大小））实时性粒度小，组合强
	
	1.2用好-查询缓存（直接缓存select语句的结果集，无需自己设计缓存逻辑）针对数据库压力。多用在目录、菜单、商品列表等。
	
	1.3开启-SQL解析缓存（全局，数据库ORM提速）
	
	1.4用好-静态缓存（通过配置，对制定控制器生成html静态文件，一般是页面做静态化）多用在有页面的情况下。接口方式主要考虑1.1和1.2
	
	1.5用好-原子性、等幂性。如：商品是有数量，避免卖单高并发情况下数量多减，一种情况是用MYSQL innodb 事务对单条商品设置排它锁。一种是并发量特别高时，我们用redis SETNX分布式锁。


2、代码自身优化到极限时候，考虑架构优化

        2.1 服务器情况，php相关服务情况，接口监控。

        2.2 php slow log分析，找出问题原因。80%不是代码的问题，是资源问题。
	
        2.3 RPC异步。由于php-fpm是阻塞式进程，直接RPC调用如果对方系统并发低，进程会等待调用成功或超时。如果一个大量外部接口调用的系统，这个时候php-fpm大量进程处于阻塞，超出服务器处理能力很容易出现502。这里采用异步概念，将PRC远程调用的逻辑用另外一套系统处理，比如：调用接口的逻辑，写在swoole task中，返回数据在swoole的 callback中，这样后面的代码会继续执行或这个控制器不会一直等待。
	
	
3、架构优化极限的时候，考虑架构升级

        3.1更换底层，比如:crontab做任务调度维护很困难，用laravel任务调度来实现。定时任务不要用php-fpm来执行。
   
        3.2 流量管理、自动降级服务、健全高可用。
   
